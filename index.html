<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script src="libs/jquery.js"></script>
    <script src="libs/underscore.js"></script>
    <script src="libs/backbone.js"></script>
</head>
<body>
<div class="wrapper">
    Property Cross
    <div class="main_screen">
    </div>
</div>

<script type="text/template" id="main_screen">
    <h1>HELLLO</h1>
    <input type="text" id="place" value="<%= this.inputVal %>"/>
    <button id="search">Search</button>
    <button id="my_location">Go</button>
    <% if (error) { %>
    <h1><%= error%></h1>
    <% } else if (locations) {%>
    <ul>
        <% _.each(locations, function(loc) { %>
        <li data-place="<%= loc.place_name %>" class="loc"><%= loc.long_title %></li>
        <% }); %>
    </ul>
    <% } else if (recentSearch && recentSearch.length) { %>
    <ul>
        <% _.each(recentSearch, function(elem) { %>
        <li class="recent_search" data-placename="<%= elem.place %>"><span class="place_title"><%= elem.longName %></span><span>(<%= elem.totalRes %>)</span></li>
        <% }); %>
    </ul>
    <% } %>
</script>

<script type="text/template" id="list_screen">
    <button class="back">Back</button>
    <div class="total_results"><%= listings.length %> <% if(listings.totalResults > 20) { %> from <%= listings.totalResults %> <% } %></div>
    <ul>
        <% _.each(listings.models, function(list) { %>
        <li class="list_item" data-cid="<%= list.cid %>"><img src="<%= list.attributes.thumb_url %>" alt="thumb"/> <%= list.attributes.title%> </li>
        <% }); %>
    </ul>
    <% if(listings.totalResults > 20 && listings.length !== listings.totalResults) { %>
        <button class="show_more">Show more</button>
    <% } %>
</script>

<script type="text/template" id="item_screen">
    <button class="back">Back</button>
    <div class="details">
        <% console.log(details) %>
        <img src="<%= details.get('img_url') %>" alt="home"/>
        <span><%= details.get('summary') %></span>
    </div>
</script>

</body>
<script type="text/javascript">
    Array.prototype.remove = function(from, to) {
        var rest = this.slice((to || from) + 1 || this.length);
        this.length = from < 0 ? this.length + from : from;
        return this.push.apply(this, rest);
    };


//    -------------------------------MODELS--------------------------------
    var City = Backbone.Model.extend();
    var Location = Backbone.Model.extend();
    var Listings = Backbone.Collection.extend({
        url: 'http://api.nestoria.co.uk/api?country=uk&pretty=1&action=search_listings&encoding=json&listing_type=buy&callback=?',
        model: City,
        parse: function(resp, xhr){
            return resp.response.listings;
        }
    });
    var Locations = Backbone.Collection.extend({
        model: Location
    });
    var listings = new Listings();
    var locations = new Locations();



//    -------------------------------VIEWS--------------------------------
    var MainScreen = Backbone.View.extend({
        el: '.main_screen',
        template: _.template($('#main_screen').html()),
        render: function(val){
            console.log(this.inputVal)
            var toTemplate = {recentSearch: this.getRecentSearches() ? this.getRecentSearches() : null, error: null, locations: null};
            if(val === 'error'){
                toTemplate.error = 'ERROR!!!';
            }else if(val === 'locations'){
                toTemplate.locations = this.locations.toJSON();
            }
            this.$el.html(this.template(toTemplate))
        },
        initialize: function(){
            this.listings = listings;
            this.locations = locations;
        },
        events: {
            'click #search': 'search',
            'click #my_location': 'searchByCurrentLocation',
            'click li.recent_search': 'clickRecentSearch',
            'click li.loc': 'clickLocation'
        },

        searchByCurrentLocation: function(){
            var self = this, latitude='-1', longtitude='-1', coordinates;
            navigator.geolocation.getCurrentPosition(function(pos){
                latitude = pos.coords.latitude;
                longtitude = pos.coords.longitude;
                latitude = '51.684183';
                longtitude = '-3.431481';
                coordinates = latitude + ',' + longtitude;
                self.search(null, null, null, coordinates);
            });
        },
        getRecentSearches: function(){
            return JSON.parse(window.localStorage.getItem('recentSearches'));
        },
        clickRecentSearch: function(e){
            var target = $(e.currentTarget),
                val = target.data('placename'),
                longName = target.find('span.place_title').text();
            this.search(null, val, longName)
        },
        clickLocation: function(e){
            var target = $(e.currentTarget),
                place = target.data('place'),
                longName = target.text();

            this.search(null, place, longName);
        },
        arrayMove: function (array, from) {
            if(from === 0) return;
            var clone = array.slice(0),
                target = clone[from];
            array.remove(from);
            array.unshift(target);
        },
        findObjPositionInArray: function(arr, val, property){
            var counter = 0,
                pos = -1;
            arr.forEach(function(elem){
                if (elem[property] === val){
                    pos = counter;
                }
                counter++;
            });
            return pos;
        },
        moveElementInTop: function(recentSearches, place, totalRes){
            var from = +this.findObjPositionInArray(recentSearches, place, 'place');
            recentSearches[from]['totalRes'] = totalRes;
            this.arrayMove(recentSearches, from);
            window.localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
        },
        isPlaceInRecentSearch: function(recentSearches, place){
            var isPlaceThere = false;
            recentSearches.forEach(function(obj){
                if(obj.place === place){
                    isPlaceThere = true;
                }
            });
            return isPlaceThere;
        },
        addToRecentSearches: function (place, totalRes, longName){
            var longName = longName || (place.charAt(0).toUpperCase() + place.slice(1));
            place = place.toLowerCase();
            var recentSearches = this.getRecentSearches();
            if(recentSearches && recentSearches.length){
               if(this.isPlaceInRecentSearch(recentSearches, place)) {
                   this.moveElementInTop(recentSearches, place, totalRes);
                   return;
               }
            }else{
                recentSearches = [];
            }
            recentSearches.unshift({place: place, totalRes: totalRes, longName: longName});
            window.localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
        },
        handleResponseCode: function(resp, longName, coordinates){
            var code = resp.response.application_response_code,
                place = resp.request.location,
                totalRes = resp.response.total_results,
                longName = longName || null;
            switch(code){
                case "100":
                case "101":
                case "110":
                    if(this.listings.length){
                        if(!coordinates) this.addToRecentSearches(place, totalRes, longName);
                        this.listings.totalResults = totalRes;
                        router.navigate("listView", {trigger: true});
                    }
                    break;
                case "200":
                case "202":
                    if(this.locations.length){
                        this.render('locations');
                    }
                    break;
                default: this.render('error');

            }
        },
        search: function(e, val, longName, coordinates){
            var self = this,
                place = val || this.$el.find('#place').val();

            this.inputVal = longName || place;
            this.listings.fetch({
                data: coordinates ? {page: 1, centre_point: coordinates} : {page: 1, place_name: place},
                success: function(col, resp){
                    self.locations.reset(resp.response.locations);
                    self.handleResponseCode(resp, longName, coordinates);
                    coordinates ? (self.listings.coordinates) = coordinates : self.listings.place = place;
                    self.listings.page = +resp.response.page;
                    console.log(resp)
                }
            })
        }
    });
    var ListScreen = Backbone.View.extend({
        el: '.main_screen',
        template: _.template($('#list_screen').html()),
        render: function(){
            var toTemplate = {listings: listings};
            this.$el.html(this.template(toTemplate))
        },
        events: {
            'click .list_item': 'clickOnItem',
            'click .back': 'goBack',
            'click .show_more': 'showMore'
        },
        goBack: function(){
//            router.navigate("", {trigger: true});
            window.history.back();
            listings.coordinates = null;
        },
        clickOnItem: function(e){
            var target = $(e.currentTarget),
                cid = target.data('cid');

            router.navigate("detailView/" + cid, {trigger: true});
        },
        showMore: function(){
            var page = listings.page + 1;
            var self = this;
            listings.fetch({
                remove: false,
                data: listings.coordinates ? {page: page, centre_point: listings.coordinates} : {page: page, place_name: listings.place},
                success: function(col, resp){
                    listings.page = page;
                    self.render();
                }
            })
        }
    });

    var DetailScreen = Backbone.View.extend({
        el: '.main_screen',
        template: _.template($('#item_screen').html()),
        render: function(cid){
            var model = listings.get(cid),
                toTemplate = {details: model};
            this.$el.html(this.template(toTemplate))
        }
    });

    var mainScreen = new MainScreen();
    var listScreen = new ListScreen();
    var detailScreen = new DetailScreen();


//    -------------------------------ROUTERS--------------------------------
    var Router = Backbone.Router.extend({
        routes: {
            '' : 'home',
            'listView' : 'list_screen',
            'detailView/:cid' : 'detail_screen'
        },
        detail_screen: function(cid){
            detailScreen.render(cid)
        }
    });
    var router = new Router();
    router.on('route:home', function(){
        mainScreen.render();
    });
    router.on('route:list_screen', function(){
        listScreen.render();
    });


    Backbone.history.start();
</script>
</html>